<!-- Unique Scoped Wrapper to protect other pages -->
<div class="movie-details-container" *ngIf="movie">

    <!-- 1. Cinematic Backdrop (Fixed Background) -->
    <div class="movie-backdrop">
        <img [src]="movie.imageUrl" class="backdrop-img" alt="Backdrop">
        <div class="backdrop-overlay"></div>
    </div>

    <div class="container position-relative" style="z-index: 2;">

        <!-- Back Button -->
        <a routerLink="/home"
            class="btn btn-sm btn-outline-light rounded-pill mb-4 px-3 border-0 bg-black bg-opacity-25">
            <i class="bi bi-arrow-left me-2"></i> Back
        </a>

        <div class="row gx-lg-5">
            <!-- Left: Poster (Floating) -->
            <div class="col-lg-4 mb-4 mb-lg-0">
                <div class="position-sticky" style="top: 100px;">
                    <img [src]="movie.imageUrl" class="poster-hero img-fluid" alt="{{ movie.title }}">
                </div>
            </div>

            <!-- Right: Info Panel -->
            <div class="col-lg-8">

                <!-- Title Block -->
                <h1 class="movie-title-hero">{{ movie.title }}</h1>

                <div class="d-flex flex-wrap gap-2 mb-4">
                    <span class="meta-badge"><i class="bi bi-film"></i> {{ movie.genre }}</span>
                    <span class="meta-badge"><i class="bi bi-translate"></i> {{ movie.language }}</span>
                    <span class="meta-badge border-warning text-warning">{{ movie.censorRating }}</span>
                    <span class="meta-badge bg-success border-success text-white">
                        <i class="bi bi-star-fill text-white"></i> {{ movie.averageRating || 'N/A' }}
                    </span>
                    <span class="meta-badge"><i class="bi bi-clock"></i> {{ movie.durationMinutes }}m</span>
                </div>

                <!-- Glass Description Panel -->
                <div class="glass-panel mb-4">
                    <p class="lead text-light opacity-75 mb-0" style="font-weight: 300; line-height: 1.7;">
                        {{ movie.description }}
                    </p>
                    <div class="mt-4 pt-3 border-top border-white border-opacity-10 text-white-50 small">
                        Release Date: <span class="text-white">{{ movie.releaseDate | date:'longDate' }}</span>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="d-flex gap-3 mb-5">
                    <button [routerLink]="['/movie', movie.id, 'shows']" class="btn-book-hero flex-grow-1">
                        Book Tickets <i class="bi bi-ticket-perforated-fill"></i>
                    </button>

                    <button class="btn-watchlist-hero" (click)="toggleWatchlist()"
                        [title]="inWatchlist ? 'Remove' : 'Add to Watchlist'">
                        <i class="bi" [class.bi-heart-fill]="inWatchlist" [class.bi-heart]="!inWatchlist"
                            [class.text-danger]="inWatchlist"></i>
                    </button>
                </div>

                <!-- Reviews Section -->
                <h3 class="text-white fw-bold mb-4">Audience Reviews <span class="text-muted fw-normal fs-5">({{
                        reviews.length }})</span></h3>

                <div *ngIf="reviews.length === 0" class="glass-panel text-center py-5">
                    <i class="bi bi-chat-dots fs-1 text-muted mb-3 d-block"></i>
                    <p class="text-muted">No reviews yet. Be the first!</p>
                </div>

                <div class="d-flex flex-column gap-3 mb-5">
                    <div *ngFor="let review of reviews" class="review-card">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="avatar-circle" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                {{ (review.userName || 'U').charAt(0) }}
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold">{{ review.userName || 'Anonymous' }}</h6>
                                <div class="text-warning small">
                                    <i *ngFor="let r of [1,2,3,4,5]" class="bi"
                                        [ngClass]="r <= review.rating ? 'bi-star-fill' : 'bi-star'"></i>
                                </div>
                            </div>
                        </div>
                        <p class="mb-0 text-white-50 small">{{ review.comment }}</p>
                    </div>
                </div>

                <!-- Write Review -->
                <div class="glass-panel" *ngIf="authService.isLoggedIn()">
                    <h5 class="mb-3">Write a Review</h5>
                    <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
                        <div class="star-rating-input mb-3">
                            <i *ngFor="let r of [1,2,3,4,5]" class="bi fs-3 me-2 pointer"
                                [ngClass]="r <= reviewForm.get('rating')?.value ? 'bi-star-fill text-warning' : 'bi-star text-secondary'"
                                (click)="reviewForm.patchValue({rating: r})"></i>
                        </div>
                        <textarea class="form-control bg-dark text-white border-secondary mb-3" rows="3"
                            placeholder="Share your thoughts..." formControlName="comment"></textarea>
                        <div class="text-end">
                            <button class="btn btn-outline-light rounded-pill px-4"
                                [disabled]="reviewForm.invalid">Post</button>
                        </div>
                    </form>
                </div>
                <div *ngIf="!authService.isLoggedIn()"
                    class="alert alert-dark border-secondary d-flex align-items-center gap-3">
                    <i class="bi bi-info-circle"></i>
                    <span>Please <a routerLink="/login" class="text-white fw-bold">login</a> to write a review.</span>
                </div>

            </div>
        </div>
    </div>
</div>

<div *ngIf="loading" class="d-flex justify-content-center align-items-center vh-100 bg-black">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<div *ngIf="error" class="container mt-5 pt-5">
    <div class="alert alert-danger">{{ error }}</div>
</div>